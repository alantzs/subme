<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SubMe! Social</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; color: white; font-family: sans-serif; }
        .view-content { height: 100vh; width: 100vw; }
        .video-container { height: 100vh; overflow-y: scroll; snap-type: y mandatory; scrollbar-width: none; }
        .video-container::-webkit-scrollbar { display: none; }
        .video-section { height: 100vh; snap-align: start; position: relative; display: flex; align-items: center; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .view-hidden { display: none !important; }
        #commentPanel { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 200; }
        #commentPanel.active { transform: translateY(0); }
        .heart-pop { position: absolute; pointer-events: none; color: #ff2d55; fill: #ff2d55; animation: pop 0.6s ease-out forwards; z-index: 100; }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.6); opacity: 1; } 100% { transform: scale(1.2); opacity: 0; } }
        .nav-item.active { color: white; }
        .profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 100%; }
        .grid-item { aspect-ratio: 3/4; background: #111; overflow: hidden; }
        .sub-badge { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #ff2d55; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border: 2px solid black; cursor: pointer; }
    </style>
</head>
<body>

    <div id="view-home" class="view-content">
        <header class="fixed top-0 w-full flex justify-center py-4 z-50 pointer-events-none">
            <img src="logo.jpg" alt="SubMe!" class="h-10 pointer-events-auto" onerror="this.outerHTML='<h1 class=\'text-2xl font-black italic\'>SubMe!</h1>'">
        </header>
        <div class="video-container" id="mainFeed">
            <div id="emptyFeed" class="h-full flex flex-col items-center justify-center p-10 text-center text-zinc-600">
                <i data-lucide="clapperboard" class="w-16 h-16 mb-4"></i>
                <p>Нет видео. Будь первым — загрузи контент!</p>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view-content view-hidden bg-black overflow-y-auto pt-12">
        <div class="p-6 flex flex-col items-center">
            <div class="relative" onclick="document.getElementById('avatarInp').click()">
                <div id="p-avatar-box" class="w-24 h-24 rounded-full bg-zinc-800 flex items-center justify-center text-3xl font-bold border-4 border-white/10 overflow-hidden">
                    <span id="p-avatar-text">A</span>
                    <img id="p-avatar-img" class="hidden w-full h-full object-cover">
                </div>
                <input type="file" id="avatarInp" accept="image/*" class="hidden" onchange="updateAvatar(this)">
            </div>
            <h2 id="p-name" class="text-2xl font-bold mt-4">@alan</h2>
            <p id="p-bio" class="text-zinc-500 text-sm mt-1">Описание профиля...</p>
            
            <div class="flex gap-8 my-6 text-center w-full justify-center">
                <div><div id="follower-count" class="font-bold">0</div><div class="text-[10px] text-zinc-500 uppercase">Подписчики</div></div>
                <div><div id="total-likes" class="font-bold">0</div><div class="text-[10px] text-zinc-500 uppercase">Лайки</div></div>
            </div>

            <button onclick="toggleEdit(true)" class="w-full max-w-[200px] py-2 bg-zinc-900 rounded-lg font-bold text-sm border border-white/5 mb-8">Изм. профиль</button>
            <div id="profileGrid" class="profile-grid"></div>
            
            <div id="p-edit" class="hidden fixed inset-0 bg-black z-[300] p-6 flex flex-col gap-4">
                <h2 class="text-xl font-bold mb-4">Настройки</h2>
                <input id="in-name" type="text" class="bg-zinc-900 p-4 rounded-xl outline-none" placeholder="Никнейм">
                <textarea id="in-bio" class="bg-zinc-900 p-4 rounded-xl outline-none h-32" placeholder="О себе"></textarea>
                <button onclick="saveProfile()" class="bg-white text-black font-bold py-4 rounded-xl">Сохранить</button>
                <button onclick="toggleEdit(false)" class="text-zinc-500">Отмена</button>
            </div>
        </div>
    </div>

    <div id="commentPanel" class="fixed bottom-0 left-0 right-0 bg-zinc-900 rounded-t-[32px] h-[65vh] flex flex-col p-6 shadow-2xl border-t border-white/10">
        <div class="flex justify-between items-center mb-4"><h3 class="font-bold">Комментарии</h3><button onclick="closeComments()"><i data-lucide="x"></i></button></div>
        <div id="commentList" class="flex-1 overflow-y-auto space-y-3 mb-4"></div>
        <div class="flex gap-2 bg-black/40 p-2 rounded-2xl border border-white/5">
            <input id="commentInp" type="text" class="flex-1 bg-transparent px-4 py-2 outline-none" placeholder="Написать...">
            <button onclick="sendComment()" class="bg-white text-black p-2 rounded-xl"><i data-lucide="send" class="w-5 h-5"></i></button>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full h-20 bg-black border-t border-white/5 flex justify-around items-center z-[150] px-6">
        <button onclick="switchView('home', this)" class="nav-item active text-zinc-500"><i data-lucide="home"></i></button>
        <button onclick="openUpload()" class="bg-white text-black w-12 h-9 rounded-lg flex items-center justify-center -mt-2"><i data-lucide="plus"></i></button>
        <button onclick="switchView('profile', this)" class="nav-item text-zinc-500"><i data-lucide="user"></i></button>
    </nav>

    <div id="modalUpload" class="fixed inset-0 bg-black/95 z-[1000] hidden items-center justify-center p-6">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[32px] p-6 border border-white/10">
            <h2 class="text-xl font-bold mb-4 text-center">Загрузить видео</h2>
            <input type="file" id="f-video" accept="video/*" class="mb-4 text-sm w-full">
            <textarea id="f-desc" class="w-full bg-zinc-800 rounded-xl p-3 text-sm mb-4 outline-none h-20" placeholder="Описание..."></textarea>
            <button onclick="publish()" class="w-full bg-white text-black font-bold py-3 rounded-xl">ОПУБЛИКОВАТЬ</button>
            <button onclick="document.getElementById('modalUpload').style.display='none'" class="w-full mt-2 text-zinc-500">Отмена</button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- ЛОГИКА ПЕРЕКЛЮЧЕНИЯ И ССЫЛОК ---
        function switchView(id, btn) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('view-hidden'));
            document.getElementById('view-' + id).classList.remove('view-hidden');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // Обновляем ссылку в браузере (как в WinTube)
            const url = new URL(window.location);
            if (id === 'profile') {
                const name = document.getElementById('p-name').innerText.replace('@', '');
                url.searchParams.set('user', name);
                url.searchParams.delete('video');
            } else {
                url.searchParams.delete('user');
                url.searchParams.delete('video');
            }
            window.history.pushState({}, '', url);
            
            if(id !== 'home') document.querySelectorAll('video').forEach(v => v.pause());
            closeComments();
        }

        // Обработка ссылок при загрузке
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('user')) {
                switchView('profile');
            } else if (params.has('video')) {
                const vidIdx = params.get('video');
                // Логика прокрутки к видео, если видео уже загружены
            }
        });

        // --- ФУНКЦИИ ПРОФИЛЯ ---
        function toggleEdit(show) { document.getElementById('p-edit').classList.toggle('hidden', !show); }
        function saveProfile() {
            const n = document.getElementById('in-name').value || 'alan';
            const b = document.getElementById('in-bio').value || '';
            document.getElementById('p-name').innerText = '@' + n;
            document.getElementById('p-bio').innerText = b;
            toggleEdit(false);
            // Обновляем URL сразу после смены имени
            const url = new URL(window.location);
            url.searchParams.set('user', n);
            window.history.replaceState({}, '', url);
        }

        function updateAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('p-avatar-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('p-avatar-text').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- ВИДЕО И ЛАЙКИ ---
        function publish() {
            const file = document.getElementById('f-video').files[0];
            const desc = document.getElementById('f-desc').value;
            if(!file) return alert('Выбери файл!');
            
            document.getElementById('emptyFeed').classList.add('hidden');
            const url = URL.createObjectURL(file);
            const user = document.getElementById('p-name').innerText;
            const avatar = document.getElementById('p-avatar-img').src;

            const sec = document.createElement('section');
            sec.className = 'video-section';
            const vidId = document.querySelectorAll('.video-section').length + 1;
            
            sec.innerHTML = `
                <video src="${url}" loop playsinline autoplay onclick="this.paused?this.play():this.pause()"></video>
                <div class="absolute right-4 bottom-28 flex flex-col gap-6 items-center z-10">
                    <div class="relative mb-2" onclick="switchView('profile')">
                        <div class="w-12 h-12 rounded-full border-2 border-white bg-zinc-800 overflow-hidden flex items-center justify-center font-bold">
                            ${avatar ? `<img src="${avatar}" class="w-full h-full object-cover">` : `<span>${user[1]}</span>`}
                        </div>
                        <div class="sub-badge" onclick="subscribe(this, event)"><i data-lucide="plus" class="w-3 h-3 text-white"></i></div>
                    </div>
                    <div class="flex flex-col items-center" onclick="toggleLike(this, event)">
                        <i data-lucide="heart" class="w-9 h-9"></i>
                        <span class="count text-xs font-bold">0</span>
                    </div>
                    <div class="flex flex-col items-center" onclick="openComments(event)">
                        <i data-lucide="message-circle" class="w-9 h-9"></i>
                        <span class="text-xs font-bold">0</span>
                    </div>
                    <div class="flex flex-col items-center" onclick="shareVid(${vidId})">
                        <i data-lucide="share-2" class="w-9 h-9"></i>
                    </div>
                </div>
                <div class="absolute bottom-28 left-6 right-20 pointer-events-none">
                    <h3 class="font-bold text-lg">${user}</h3>
                    <p class="text-sm opacity-80">${desc}</p>
                </div>
            `;
            
            document.getElementById('mainFeed').prepend(sec);
            const gi = document.createElement('div');
            gi.className = 'grid-item';
            gi.innerHTML = `<video src="${url}" class="w-full h-full object-cover" muted></video>`;
            document.getElementById('profileGrid').prepend(gi);
            
            lucide.createIcons();
            document.getElementById('modalUpload').style.display = 'none';
            switchView('home');
        }

        function toggleLike(btn, e) {
            e.stopPropagation();
            const icon = btn.querySelector('svg');
            const num = btn.querySelector('.count');
            const total = document.getElementById('total-likes');
            let val = parseInt(num.innerText);
            if(icon.classList.contains('fill-red-500')) {
                icon.classList.remove('fill-red-500', 'text-red-500');
                num.innerText = val - 1;
                total.innerText = parseInt(total.innerText) - 1;
            } else {
                icon.classList.add('fill-red-500', 'text-red-500');
                num.innerText = val + 1;
                total.innerText = parseInt(total.innerText) + 1;
                popHeart(e);
            }
        }

        function popHeart(e) {
            const h = document.createElement('div');
            h.className = 'heart-pop';
            h.innerHTML = `<i data-lucide="heart" style="width:80px; height:80px;"></i>`;
            h.style.left = (e.clientX - 40) + 'px'; h.style.top = (e.clientY - 40) + 'px';
            document.body.appendChild(h); lucide.createIcons();
            setTimeout(() => h.remove(), 600);
        }

        function subscribe(el, e) {
            e.stopPropagation();
            el.style.display = 'none';
            const c = document.getElementById('follower-count');
            c.innerText = parseInt(c.innerText) + 1;
        }

        function shareVid(id) {
            const url = new URL(window.location);
            url.searchParams.set('video', id);
            navigator.clipboard.writeText(url.href);
            alert("Ссылка на видео скопирована!");
        }

        // Комменты
        function openComments(e) { e.stopPropagation(); document.getElementById('commentPanel').classList.add('active'); }
        function closeComments() { document.getElementById('commentPanel').classList.remove('active'); }
        function sendComment() {
            const i = document.getElementById('commentInp'); if(!i.value) return;
            const d = document.createElement('div');
            d.innerHTML = `<b class="text-xs">@вы:</b> <p class="text-sm">${i.value}</p>`;
            document.getElementById('commentList').prepend(d);
            i.value = '';
        }
        function openUpload() { document.getElementById('modalUpload').style.display='flex'; }
    </script>
</body>
</html>
